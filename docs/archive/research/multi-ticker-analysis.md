# 멀티 티커 & 병렬 데이터 수집 검토

## 📅 2026-01-31

---

## 질문 1: 차트 데이터 병렬 수집이 가능한가?

### 현재 구조

```
┌─────────────────────────────────────────────┐
│            Pocket Option (1 Tab)            │
├─────────────────────────────────────────────┤
│  DataCollector ──► DOM ──► 1개 차트만 표시   │
│                                             │
│  MutationObserver가 가격 변화 감지          │
│  → 한 번에 1개 티커만 모니터링              │
└─────────────────────────────────────────────┘
```

### 병렬 수집 방법

| 방법 | 가능 여부 | 장점 | 단점 |
|------|----------|------|------|
| **방법 1: 멀티탭** | ✅ 가능 | 구현 간단 | 리소스 사용 ↑, 관리 복잡 |
| **방법 2: 외부 API** | ✅ 가능 | 빠름, 안정적 | Pocket Option 가격과 차이 발생 가능 |
| **방법 3: 빠른 티커 전환** | ⚠️ 제한적 | 단일 탭으로 가능 | 데이터 누락, 지연 |

### 방법 1: 멀티탭 구조

```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   Tab 1     │  │   Tab 2     │  │   Tab 3     │
│  BTC/USD    │  │  EUR/USD    │  │  Gold OTC   │
│  Content    │  │  Content    │  │  Content    │
│  Script     │  │  Script     │  │  Script     │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                │
       └────────────────┼────────────────┘
                        ▼
              ┌─────────────────┐
              │   Background    │
              │  Service Worker │
              │  (데이터 통합)   │
              └─────────────────┘
```

**구현 요구사항:**
- Background에서 여러 탭 관리
- 탭별 티커 할당
- 데이터 통합 & 동기화

### 방법 2: 외부 API 병렬 수집 ❌ 기각

```typescript
// 예시: Binance WebSocket 멀티 스트림
const symbols = ['btcusdt', 'ethusdt', 'eurusd'];
const ws = new WebSocket(
  `wss://stream.binance.com:9443/stream?streams=${symbols.map(s => `${s}@trade`).join('/')}`
);
```

**❌ 기각 사유 (2026-01-31):**
- **Pocket Option 가격과 외부 API 가격이 다름**
- 백테스트 결과가 실제 거래와 괴리 발생
- 특히 OTC 자산은 Pocket Option 자체 가격 사용

**결론:** 외부 API는 분석용으로도 부적합. Pocket Option DOM에서 직접 수집해야 함.

---

## 질문 2: 여러 티커에 동시 투자가 가능한가?

### Pocket Option UI 제약

```
┌────────────────────────────────────────────────┐
│              Pocket Option UI                  │
├────────────────────────────────────────────────┤
│  ✅ 한 번에 1개 차트만 표시                    │
│  ✅ 한 번에 1개 자산만 거래 가능               │
│  ✅ 미청산 거래는 여러 개 동시 보유 가능       │
│  ❌ 동시에 다른 자산 2개 매수 불가 (UI 제약)   │
└────────────────────────────────────────────────┘
```

### 동시 투자 전략

#### 전략 A: 순차적 빠른 전환 (단일 탭)

```
시간   0s     1s     2s     3s     4s
       │      │      │      │      │
       BTC매수 ─► EUR전환 ─► EUR매수 ─► Gold전환...
       
장점: 단일 탭, 리소스 ↓
단점: 타이밍 놓칠 수 있음 (전환 시간 ~1-2초)
```

#### 전략 B: 멀티탭 동시 거래

```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   Tab 1     │  │   Tab 2     │  │   Tab 3     │
│  BTC/USD    │  │  EUR/USD    │  │  Gold OTC   │
│             │  │             │  │             │
│  CALL 매수  │  │  PUT 매수   │  │  CALL 매수  │
│  동시 실행  │  │  동시 실행  │  │  동시 실행  │
└─────────────┘  └─────────────┘  └─────────────┘

장점: 진정한 병렬 거래
단점: 계정 제약 확인 필요, 리소스 ↑
```

#### 전략 C: 페이아웃 기반 단일 최적 자산

```
PayoutMonitor
    │
    ▼
[92%+ 자산 필터링]
    │
    ▼
[가장 높은 페이아웃 선택]
    │
    ▼
[해당 자산만 집중 거래]

장점: 단순함, 최적화됨
단점: 분산 투자 불가
```

---

## 📊 결론 및 권장사항

### 권장 구조: 하이브리드 접근

```
Phase 1 (현재):
  └─ 단일 탭 + PayoutMonitor
  └─ 92%+ 최고 페이아웃 자산 1개 집중

Phase 2 (확장):
  └─ 외부 API로 데이터 병렬 수집 (분석용)
  └─ Pocket Option은 여전히 단일 탭 거래

Phase 3 (고급):
  └─ 멀티탭 구조 (3-5탭)
  └─ 각 탭 다른 자산 담당
  └─ Background에서 통합 관리
```

### 우선순위

| 순위 | 기능 | 복잡도 | 영향 |
|------|------|--------|------|
| 1 | PayoutMonitor 92%+ 필터링 | 낮음 | 높음 |
| 2 | 빠른 자산 전환 자동화 | 중간 | 중간 |
| 3 | 외부 API 데이터 수집 | 중간 | 낮음 (분석용) |
| 4 | 멀티탭 병렬 거래 | 높음 | 높음 |

### ⚠️ 확인 필요 사항

1. **Pocket Option 계정 제약**: 동시 오픈 포지션 제한이 있는지?
2. **같은 계정 멀티탭 허용**: ToS 위반 가능성?
3. **OTC 자산 외부 데이터**: OTC 가격 데이터 API가 있는지?

---

## 🔧 구현 가이드 (Phase 1)

### PayoutMonitor 활용

```typescript
// 현재 이미 구현됨: payout-monitor.ts

const monitor = getPayoutMonitor();
monitor.setFilter({ minPayout: 92, onlyOTC: true });
await monitor.start();

// 최고 페이아웃 자산 가져오기
const best = monitor.getBestAsset();
console.log(`Best: ${best.name} (${best.payout}%)`);
```

### 자산 자동 전환 (TODO)

```typescript
// executor.ts에 추가 필요
async function switchToAsset(assetName: string): Promise<boolean> {
  // 1. 자산 드롭다운 열기
  // 2. 자산 검색/클릭
  // 3. 차트 로드 대기
  // 4. 성공 여부 반환
}
```

---

## 📝 다음 단계

- [ ] Pocket Option 동시 포지션 제한 확인 (실험)
- [ ] 자산 전환 함수 구현 (`switchToAsset`)
- [ ] 외부 API 데이터 소스 비교 (Binance vs TradingView)
- [ ] 멀티탭 아키텍처 설계 (Phase 3용)
